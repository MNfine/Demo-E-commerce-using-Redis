<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    <link rel="stylesheet" href="static/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
</head>
<body>
    <header>
        <div class="logo">Bike for Style</div>
        <nav>
            <a href="/home">Home</a>
            <a href="/products" class="active">Product</a>
            <a href="/about">About us</a>
            <a href="/join">Join us</a>
        </nav>
        <div class="icons">
            <span>
                <i class="bi bi-search"></i>
            </span>
            <span>
                <i class="bi bi-bell"></i>
            </span>
            <span class="cart-span" onclick="toggleCart()"> 
                <i class="bi bi-basket"></i>
                <span id="cart-count" class="cart-count">0</span>  
            </span>
            <span>
                <i class="bi bi-person"></i>  
            </span>
        </div>
        <div id="cart-container" class="cart-container">
            <h3 style="color: black">Your cart</h3>
            <ul id="cart-items"></ul>
            <button onclick="closeCart()">Close</button>
            <button onclick="clearCart()" style="display: left">Clear Cart</button>
        </div>             
    </header>
    <main>
        <h1>EBIKE</h1>
        <div class="product-list">
            {% for product in products %}
            <div class="product">
                <img src="{{ product.image_path }}">
                <h3>{{ product.name }}</h3>
                <div class="form-group">
                    <p>Price: {{ product.price }}$</p>
                    <button onclick="addToCart('{{ product.product_id }}')">Add to cart</button>
                </div>
            </div>
            {% endfor %}
        </div>        
    </main>
    <button id="chat_toggle" class="chat-button">ðŸ’¬ Chat</button>

    <div id="chat_container" class="chat-container hidden">
        <div id="chat_header">
            Customer support
            <button id="chat_close" class="close-button">âœ–</button>
        </div>
        <div id="chatbox" class="chatbox-content"></div>
        <div id="chat_input_container">
            <input type="text" id="chat_input" placeholder="Nháº­p tin nháº¯n...">
            <button onclick="sendMessage()">Gá»­i</button>
        </div>
    </div>
    <script>
        function addToCart(product_id) {
            let session_id = localStorage.getItem("session_id");
            fetch('/cart/add', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': session_id  
                },
                body: JSON.stringify({ product_id: product_id, quantity: 1 })
            })
            .then(response => response.json())
            .then(data => {
                if (data.cart) {
                    document.getElementById('cart-count').innerText = Object.values(data.cart).reduce((a, b) => parseInt(a) + parseInt(b), 0);
                }
                updateCartCount();
            })
            .catch(error => console.error('Error:', error));
        }
        function updateCartCount() {
            let session_id = localStorage.getItem("session_id");

            fetch('/cart/count', {
                method: 'GET',
                headers: {
                    "Authorization": session_id,  // Gá»­i session_id
                    "Content-Type": "application/json"
                }
            })
            .then(response => response.json())
            .then(data => {
                let cartCountElement = document.getElementById('cart-count');
                if (data.total_quantity > 0) {
                    cartCountElement.innerText = data.total_quantity;
                    cartCountElement.style.display = "block";
                } else {
                    cartCountElement.style.display = "none"; 
                }
            })
        .catch(error => console.error('Error loading cart count:', error));
        }
        updateCartCount();

        function toggleCart() {
            let cartContainer = document.getElementById("cart-container");
            if (cartContainer.style.display === "none" || cartContainer.style.display === "") {
                loadCartItems();  
                cartContainer.style.display = "block";
            } else {
                cartContainer.style.display = "none";
            }
        }

        function closeCart() {
            document.getElementById("cart-container").style.display = "none";
        }
        
        function loadCartItems() {
            let session_id = localStorage.getItem("session_id");
            fetch('/cart', { 
                method: "GET",
                headers: { 
                    "Authorization": session_id,  // Gá»­i session_id
                    "Content-Type": "application/json"
                } 
            })
            .then(response => response.json())
            .then(data => {
                let cartItemsElement = document.getElementById("cart-items");
                cartItemsElement.innerHTML = ""; 

                data.items.forEach(item => {
                    let li = document.createElement("li");

                    let itemText = document.createElement("span");
                    itemText.innerHTML = `${item.name} <strong>x${item.quantity}</strong>`;

                    let deleteButton = document.createElement("button");
                    deleteButton.textContent = "Delete";
                    deleteButton.classList.add("cart-remove");
                    deleteButton.onclick = () => removeFromCart(item.product_id);

                    li.appendChild(itemText);
                    li.appendChild(deleteButton);
                    cartItemsElement.appendChild(li);
                });
            })
            .catch(error => console.error("Error:", error));
        }

        function removeFromCart(product_id) {
            let session_id = localStorage.getItem("session_id");
            fetch('/cart/remove', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': session_id  
                },
                body: JSON.stringify({ product_id: product_id, quantity: 1 })
            })
            .then(response => response.json())
            .then(data => {
                loadCartItems(); 
                updateCartCount(); 
            })
            .catch(error => console.error("Error", error));
        }

        function clearCart() {
            let session_id = localStorage.getItem("session_id");
            fetch('/cart/clear', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': session_id  
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("cart-items").innerHTML = ""; 
                updateCartCount(); 
            })
            .catch(error => console.error("Error clearing cart:", error));
        }
        // Dá»±a vÃ o link ngrok Ä‘á»ƒ káº¿t ná»‘i vá»›i server 
        const socket = io("https://ecd4-101-99-36-202.ngrok-free.app", {
            transports: ["websocket", "polling"],
            query: { session_id: localStorage.getItem("session_id") },
            pingInterval: 25000,  // Ping má»—i 25 giÃ¢y
            pingTimeout: 60000    // Timeout sau 60 giÃ¢y náº¿u khÃ´ng cÃ³ pháº£n há»“i
        });
        const chatbox = document.getElementById("chatbox");
        const chatContainer = document.getElementById("chat_container");
        const chatToggle = document.getElementById("chat_toggle");
        const chatClose = document.getElementById("chat_close");
    
        chatContainer.style.display = "none";

        chatToggle.addEventListener("click", () => {
            chatContainer.style.display = (chatContainer.style.display === "none") ? "block" : "none";
        });
    
        chatClose.addEventListener("click", () => {
            chatContainer.style.display = "none";
        });

        function sendMessage() {
            const message = document.getElementById("chat_input").value;
            const session_id = localStorage.getItem("session_id");

            if(!session_id){
                alert("Please login!")
                return;
            }

            if (message.trim() !== "") {
                socket.emit("user_message", { 
                    message: message,
                    session_id: session_id
                 });
                chatbox.innerHTML += `<p><strong>Báº¡n:</strong> ${message}</p>`;
                document.getElementById("chat_input").value = "";
            }
        }

        socket.on("chatbot_response", function (data) {
            chatbox.innerHTML += `<p><strong>Chatbot:</strong> ${data.message}</p>`;
            chatbox.scrollTop = chatbox.scrollHeight;
        });

        socket.on("agent_response", function (data) {
            chatbox.innerHTML += `<p><strong>TÆ° váº¥n viÃªn:</strong> ${data.message}</p>`;
            chatbox.scrollTop = chatbox.scrollHeight;
        });
    </script>        
</body>
</html>
